<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Research Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a365d;
            --secondary: #475569;
            --accent: #0891b2;
            --success: #059669;
            --warning: #d97706;
            --error: #e11d48;
            --bg: #f8fafc;
            --surface: #ffffff;
        }
        body { font-family: 'Inter', system-ui, sans-serif; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .message-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .session-card:hover { background: #f1f5f9; }
        .session-card.active { background: #e0f2fe; border-left: 3px solid var(--accent); }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col">
    <!-- Header -->
    <header class="h-16 bg-white border-b border-slate-200 flex items-center px-4 shrink-0">
        <div class="flex items-center gap-3">
            <button id="toggle-sidebar" class="p-2 hover:bg-slate-100 rounded-lg lg:hidden">
                <i class="fas fa-bars text-slate-600"></i>
            </button>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-cyan-500 rounded-lg flex items-center justify-center">
                    <i class="fas fa-brain text-white text-sm"></i>
                </div>
                <span class="font-semibold text-slate-800">Research Assistant</span>
            </div>
        </div>
        <div class="flex-1 max-w-xl mx-4">
            <div class="relative">
                <input type="text" id="global-search" placeholder="Search conversations..." 
                       class="w-full px-4 py-2 pl-10 bg-slate-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span id="llm-status" class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                <i class="fas fa-circle text-xs mr-1"></i> LLM Online
            </span>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Left Sidebar - History -->
        <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 flex flex-col shrink-0 transition-transform lg:translate-x-0 -translate-x-full fixed lg:relative h-[calc(100vh-4rem)] z-20">
            <!-- New Chat Button -->
            <div class="p-4 border-b border-slate-200">
                <button id="new-chat-btn" onclick="createNewSession()" 
                        class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>

            <!-- Session List -->
            <div class="flex-1 overflow-y-auto scrollbar-thin">
                <div class="p-3">
                    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Today</h3>
                    <div id="sessions-today" class="space-y-1"></div>
                </div>
                <div class="p-3">
                    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Previous</h3>
                    <div id="sessions-previous" class="space-y-1"></div>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-3 border-t border-slate-200 space-y-2">
                <button onclick="showDocuments()" class="w-full py-2 px-3 text-left text-sm text-slate-600 hover:bg-slate-100 rounded-lg flex items-center gap-2">
                    <i class="fas fa-folder text-slate-400"></i>
                    Documents
                    <span id="doc-count" class="ml-auto bg-slate-200 px-2 py-0.5 rounded text-xs">0</span>
                </button>
                <button onclick="showExportOptions()" class="w-full py-2 px-3 text-left text-sm text-slate-600 hover:bg-slate-100 rounded-lg flex items-center gap-2">
                    <i class="fas fa-download text-slate-400"></i>
                    Export Chat
                </button>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col min-w-0">
            <!-- Session Info Bar -->
            <div id="session-bar" class="h-12 bg-white border-b border-slate-200 flex items-center px-4 shrink-0">
                <span id="session-title" class="font-medium text-slate-700">New Conversation</span>
                <span id="session-meta" class="ml-3 text-xs text-slate-400"></span>
                <div class="ml-auto flex items-center gap-2">
                    <button onclick="toggleAgentSpace()" class="p-2 hover:bg-slate-100 rounded-lg text-slate-500" title="Agent Space">
                        <i class="fas fa-robot"></i>
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-thin">
                <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                    <i class="fas fa-comments text-6xl mb-4 text-slate-300"></i>
                    <p class="text-lg font-medium">Start a conversation</p>
                    <p class="text-sm">Upload documents and ask questions about them</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-white border-t border-slate-200 p-4 shrink-0">
                <div class="max-w-4xl mx-auto">
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <textarea id="message-input" rows="1" placeholder="Ask a question..." 
                                      class="w-full px-4 py-3 bg-slate-100 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                      onkeydown="handleKeyDown(event)"></textarea>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="p-3 bg-slate-100 hover:bg-slate-200 rounded-xl cursor-pointer transition-all">
                                <i class="fas fa-paperclip text-slate-500"></i>
                                <input type="file" id="file-input" class="hidden" onchange="handleFileUpload(event)">
                            </label>
                            <button id="send-btn" onclick="sendMessage()" 
                                    class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-2 text-xs text-slate-400">
                        <span>Press Enter to send, Shift+Enter for new line</span>
                        <span id="token-info">Context: Ready</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel - Agent Space -->
        <aside id="agent-space" class="w-80 bg-white border-l border-slate-200 flex-col shrink-0 hidden lg:flex">
            <div class="p-4 border-b border-slate-200">
                <h2 class="font-semibold text-slate-700 flex items-center gap-2">
                    <i class="fas fa-robot text-blue-500"></i>
                    Agent Space
                </h2>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin">
                <!-- Capabilities -->
                <div class="bg-slate-50 rounded-lg p-3">
                    <h3 class="text-xs font-semibold text-slate-500 uppercase mb-2">Active Capabilities</h3>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Code Execution</span>
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Data Analysis</span>
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Visualization</span>
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">File Ops</span>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div>
                    <h3 class="text-xs font-semibold text-slate-500 uppercase mb-2">Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="quickAction('analyze')" class="p-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm text-slate-600 flex flex-col items-center gap-1">
                            <i class="fas fa-chart-bar text-blue-500"></i>
                            Analyze Data
                        </button>
                        <button onclick="quickAction('visualize')" class="p-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm text-slate-600 flex flex-col items-center gap-1">
                            <i class="fas fa-chart-pie text-green-500"></i>
                            Create Chart
                        </button>
                        <button onclick="quickAction('code')" class="p-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm text-slate-600 flex flex-col items-center gap-1">
                            <i class="fas fa-code text-purple-500"></i>
                            Run Code
                        </button>
                        <button onclick="quickAction('export')" class="p-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm text-slate-600 flex flex-col items-center gap-1">
                            <i class="fas fa-file-export text-orange-500"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Recent Operations -->
                <div>
                    <h3 class="text-xs font-semibold text-slate-500 uppercase mb-2">Recent Operations</h3>
                    <div id="recent-ops" class="space-y-2 text-sm text-slate-500">
                        <p class="text-center py-4">No recent operations</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        let currentSessionId = null;
        let chatHistory = [];
        let sessions = [];

        async function init() {
            await loadSessions();
            await checkLLMStatus();
            await fetchStats();
        }

        async function checkLLMStatus() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                const status = document.getElementById('llm-status');
                if (data.llm_available) {
                    status.innerHTML = '<i class="fas fa-circle text-xs mr-1"></i> LLM Online';
                    status.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
                } else {
                    status.innerHTML = '<i class="fas fa-circle text-xs mr-1"></i> LLM Offline';
                    status.className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700';
                }
            } catch (e) {
                console.error('Health check failed:', e);
            }
        }

        async function fetchStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                document.getElementById('doc-count').textContent = data.total_documents || 0;
            } catch (e) {}
        }

        async function loadSessions() {
            try {
                const res = await fetch('/api/sessions/recent?limit=20');
                sessions = await res.json();
                renderSessions();
            } catch (e) {
                console.error('Failed to load sessions:', e);
                sessions = [];
                renderSessions();
            }
        }

        function renderSessions() {
            const today = new Date().toDateString();
            const todayContainer = document.getElementById('sessions-today');
            const prevContainer = document.getElementById('sessions-previous');
            
            todayContainer.innerHTML = '';
            prevContainer.innerHTML = '';

            if (!sessions.length) {
                todayContainer.innerHTML = '<p class="text-sm text-slate-400 py-2">No conversations yet</p>';
                return;
            }

            sessions.forEach(session => {
                const sessionDate = new Date(session.created_at).toDateString();
                const isToday = sessionDate === today;
                const container = isToday ? todayContainer : prevContainer;
                
                const card = document.createElement('div');
                card.className = `session-card p-3 rounded-lg cursor-pointer ${session.id === currentSessionId ? 'active' : ''}`;
                card.onclick = () => loadSession(session.id);
                
                card.innerHTML = `
                    <div class="font-medium text-sm text-slate-700 truncate">${session.title || 'Untitled'}</div>
                    <div class="text-xs text-slate-400 mt-1 truncate">${session.last_message_preview || 'No messages'}</div>
                    <div class="text-xs text-slate-400 mt-1">${formatTime(session.updated_at)}</div>
                `;
                
                container.appendChild(card);
            });
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
            return date.toLocaleDateString();
        }

        async function createNewSession() {
            try {
                const res = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: 'New Chat'})
                });
                const session = await res.json();
                currentSessionId = session.id;
                chatHistory = [];
                
                document.getElementById('messages').innerHTML = `
                    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                        <i class="fas fa-comments text-6xl mb-4 text-slate-300"></i>
                        <p class="text-lg font-medium">Start a conversation</p>
                        <p class="text-sm">Upload documents and ask questions about them</p>
                    </div>
                `;
                document.getElementById('session-title').textContent = 'New Conversation';
                document.getElementById('session-meta').textContent = '';
                
                await loadSessions();
            } catch (e) {
                console.error('Failed to create session:', e);
                currentSessionId = 'temp_' + Date.now();
            }
        }

        async function loadSession(sessionId) {
            try {
                const res = await fetch(`/api/sessions/${sessionId}?include_messages=true`);
                const session = await res.json();
                
                currentSessionId = sessionId;
                document.getElementById('session-title').textContent = session.title || 'Conversation';
                document.getElementById('session-meta').textContent = `${session.message_count || 0} messages`;
                
                const container = document.getElementById('messages');
                container.innerHTML = '';
                
                if (session.messages && session.messages.length > 0) {
                    chatHistory = session.messages.map(m => ({
                        role: m.role,
                        content: m.content,
                        metadata: m.metadata
                    }));
                    
                    session.messages.forEach(m => {
                        addMessage(m.role, m.content, m.metadata);
                    });
                } else {
                    container.innerHTML = `
                        <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                            <i class="fas fa-comments text-6xl mb-4 text-slate-300"></i>
                            <p class="text-lg font-medium">Continue this conversation</p>
                        </div>
                    `;
                    chatHistory = [];
                }
                
                renderSessions();
            } catch (e) {
                console.error('Failed to load session:', e);
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.remove();

            addMessage('user', message);
            chatHistory.push({role: 'user', content: message});

            showTypingIndicator();

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: message,
                        session_id: currentSessionId
                    })
                });
                
                const data = await res.json();
                hideTypingIndicator();

                if (data.success) {
                    addMessage('assistant', data.answer, {
                        confidence: data.confidence,
                        verified: data.verified,
                        sources: data.sources,
                        image_paths: data.image_paths
                    });
                    chatHistory.push({
                        role: 'assistant',
                        content: data.answer,
                        metadata: {confidence: data.confidence, verified: data.verified}
                    });
                } else {
                    addMessage('assistant', data.error || 'An error occurred', {error: true});
                }
            } catch (e) {
                hideTypingIndicator();
                addMessage('assistant', 'Failed to get response: ' + e.message, {error: true});
            }
        }

        function addMessage(role, content, metadata = null) {
            const container = document.getElementById('messages');
            const wrapper = document.createElement('div');
            wrapper.className = `message-enter flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-2xl rounded-2xl px-4 py-3 ${
                role === 'user' 
                    ? 'bg-blue-600 text-white' 
                    : metadata?.error 
                        ? 'bg-red-50 text-red-700 border border-red-200' 
                        : 'bg-white border border-slate-200 text-slate-700'
            }`;
            
            let html = `<p class="whitespace-pre-wrap text-sm">${escapeHtml(content)}</p>`;
            
            if (metadata && role === 'assistant' && !metadata.error) {
                html += `
                    <div class="mt-3 pt-3 border-t ${role === 'user' ? 'border-blue-500' : 'border-slate-200'} flex gap-4 text-xs">
                        <span class="${metadata.confidence >= 0.7 ? 'text-green-600' : 'text-yellow-600'}">
                            Confidence: ${(metadata.confidence * 100).toFixed(0)}%
                        </span>
                        <span class="${metadata.verified ? 'text-green-600' : 'text-slate-400'}">
                            ${metadata.verified ? 'Verified' : 'Unverified'}
                        </span>
                    </div>
                `;
                
                if (metadata.image_paths && metadata.image_paths.length > 0) {
                    html += `<div class="mt-3 space-y-2">`;
                    metadata.image_paths.forEach(img => {
                        html += `
                            <div class="bg-slate-50 rounded-lg p-2">
                                <img src="${img.path}" alt="Figure" class="max-w-full rounded" onerror="this.style.display='none'">
                                <div class="text-xs text-slate-500 mt-1">Source: ${img.source} (Page ${img.page})</div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
            }
            
            bubble.innerHTML = html;
            wrapper.appendChild(bubble);
            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('messages');
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'flex justify-start message-enter';
            indicator.innerHTML = `
                <div class="bg-white border border-slate-200 rounded-2xl px-4 py-3">
                    <div class="flex gap-1">
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                    </div>
                </div>
            `;
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const res = await fetch('/api/upload', {method: 'POST', body: formData});
                const data = await res.json();
                
                if (data.success) {
                    alert('Document uploaded successfully!');
                    fetchStats();
                } else {
                    alert('Upload failed: ' + data.error);
                }
            } catch (e) {
                alert('Upload failed: ' + e.message);
            }
            
            event.target.value = '';
        }

        function toggleAgentSpace() {
            const panel = document.getElementById('agent-space');
            panel.classList.toggle('hidden');
            panel.classList.toggle('flex');
        }

        function quickAction(action) {
            const input = document.getElementById('message-input');
            const prompts = {
                'analyze': 'Analyze the data in the uploaded document and provide key statistics.',
                'visualize': 'Create a chart showing the main findings from the document.',
                'code': 'Write Python code to process and analyze the document data.',
                'export': 'Export the current conversation as a report.'
            };
            input.value = prompts[action] || '';
            input.focus();
        }

        function showExportOptions() {
            if (chatHistory.length === 0) {
                alert('No conversation to export.');
                return;
            }
            
            const format = prompt('Export format: markdown, html, or pdf', 'markdown');
            if (!format) return;
            
            fetch('/api/export', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({chat_history: chatHistory, format: format})
            })
            .then(res => res.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat_export.${format === 'html' ? 'html' : 'md'}`;
                a.click();
            })
            .catch(e => alert('Export failed: ' + e.message));
        }

        function showDocuments() {
            window.location.href = '/#documents';
        }

        init();
        setInterval(checkLLMStatus, 30000);
    </script>
</body>
</html>
